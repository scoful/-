# 零、微信开发前置知识准备

## 1. openId指的是某个微信登录账号相对服务号或小程序的唯一身份标识，换句话说，同一个人，换个微信登录，获得的openId就不一样了；

## 2. 同一个微信，针对服务号的openId和小程序的openId是不一样的；

## 3. 想要把服务号的openId和小程序的openId关联起来，必须使用开发者平台，把两个关联起来，获取的unionId，就是唯一身份标识；


# 一、 微信能力介绍


## 一、发消息能力
### 1. 被动回复消息

① 需要用openId推送；

② 需要用户主动触发，5秒内发1条；

③ 业务处理必须控制在5秒内，5秒内回复，如果没有5秒内回复，会提醒“该公众号暂时无法提供服务，请稍后再试”；

④ 支持回复文本、图片、图文、语音、视频、音乐，但是，除了文本和图文，其他4个都需要素材管理接口配合使用；

⑤ 最新限制，回复图文一次只能发送一个item；

### 2. 客服消息

① 需要用openId推送；

② 需要跟用户有交互动作，并且在48小时内发送，可发送多条，条数未验证，至少10条；

③ 交互动作有：
> 1、用户发送信息；
> 
> 2、点击自定义菜单（仅有点击推事件、扫码推事件、扫码推事件且弹出“消息接收中”提示框这3种菜单类型是会触发客服接口的）；
> 
> 3、关注公众号；
> 
> 4、扫描二维码；
> 
> 5、支付成功；
> 
> 6、用户维权；

④ 支持发送文本，发送文本消息时，支持插入跳小程序的文字链

    <a href="http://www.qq.com" data-miniprogram-appid="appid" data-miniprogram-path="pages/index/index">点击跳小程序</a>

⑤ 支持发送图片、语音、视频、音乐，但是都需要素材管理接口配合使用；

⑥ 支持发送图文消息，可以用url方式也可用素材接口方式，最新限制，一次只能发送一个item；

⑦ 支持发送卡券，仅支持非自定义Code码和导入code模式的卡券的卡券*(未实现过卡券功能，待验证)*；

⑧ 支持发送小程序卡片（要求小程序与公众号已关联），可以跳转；

### 3. 群发消息

① 可通过openId列表或标签群发；

② 在微信公众号后台，订阅号每天能直接群发一条消息，服务号一个自然月能直接群发四条消息；

③ 对于认证订阅号，群发接口每天可成功调用1次，此次群发可选择发送给全部用户或某个标签；

④ 对于认证服务号，开发者通过使用高级群发接口，每日可调用限制为100次，但是用户依然每月只能接收四条，无论在公众平台网站上，还是使用接口群发，用户每月只能接收4条群发消息，多于4条的群发将对该用户发送失败；

⑤ 开发者可以使用预览接口校对消息样式和排版，通过预览接口可发送编辑好的消息给指定用户校验效果；

⑥ 群发过程中，微信后台会自动进行图文消息原创校验，请提前设置好相关参数(send_ignore等)；

⑦ 群发接口每分钟限制请求60次，超过限制的请求会被拒绝；

⑧ 图文消息正文中插入自己帐号和其他公众号已群发文章链接的能力；

⑨ 群发图文消息，需要素材管理接口配合使用：

> 1、首先，预先将图文消息中需要用到的图片，使用上传图文消息内图片接口，上传成功并获得图片 URL；
> 
> 2、上传图文消息素材，需要用到图片时，请使用上一步获取的图片 URL；
> 
> 3、使用对用户标签的群发，或对 OpenID 列表的群发，将图文消息群发出去，群发时微信会进行原创校验，并返回群发操作结果；
> 
> 4、在上述过程中，如果需要，还可以预览图文消息、查询群发状态，或删除已群发的消息等。

⑩ 群发图片、文本等其他消息类型的过程如下：

> 1、如果是群发文本消息，则直接根据下面的接口说明进行群发即可；
> 
> 2、如果是群发图片、视频等消息，则需要预先通过素材管理接口准备好 mediaID。

⑪ 关于群发时使用is_to_all为true使其进入公众号在微信客户端的历史消息列表：

> 1、使用is_to_all为true且成功群发，会使得此次群发进入历史消息列表。
> 
> 2、为防止异常，认证订阅号在一天内，只能使用is_to_all为true进行群发一次，或者在公众平台官网群发（不管本次群发是对全体还是对某个分组）一次。以避免一天内有2条群发进入历史消息列表。
> 
> 3、类似地，服务号在一个月内，使用is_to_all为true群发的次数，加上公众平台官网群发（不管本次群发是对全体还是对某个分组）的次数，最多只能是4次。
> 
> 4、设置is_to_all为false时是可以多次群发的，但每个用户只会收到最多4条，且这些群发不会进入历史消息列表。

    本接口中所有使用到media_id的地方，现在都可以使用素材管理中的永久素材media_id了，而且所上传的图片不占用公众号的素材库中图片数量的5000个的限制，
	但请注意，使用同一个素材群发出去的链接是一样的，这意味着，删除某一次群发，会导致整个链接失效。

### 4. 模板消息

① 需要用openId推送；

② 不需要有交互，只要知道openId就能推送，推送位置是服务号对话框，条数不限制，只受每日接口调用量限制；*目前汤星球限制每日调用量是100W*

③ 需要选择公众账号服务所处的2个行业，每月可更改1次所选行业；

④ 每个账号可以同时使用25个模板；

⑤ 当前每个账号的模板消息的日调用上限为10万次，单个模板没有特殊限制。当账号粉丝数超过10W/100W/1000W时，模板消息的日调用上限会相应提升，以公众号MP后台开发者中心页面中标明的数字为准。

⑥ 模板消息支持跳转url链接（海外帐号没有跳转能力），不填不跳转；

⑦ 模板消息支持跳转到小程序（该小程序appid必须与发模板消息的公众号是绑定关联关系，暂不支持小游戏），并可跳到小程序的具体页面路径，支持带参数,（示例index?foo=bar），暂不支持小游戏，不填不跳转；

⑧ 模板消息支持修改模板内容字体颜色，不填默认为黑色；

⑨ url和miniprogram都是非必填字段，若都不传则模板无跳转；若都传，会优先跳转至小程序。开发者可根据实际需要选择其中一种跳转方式即可。当用户的微信客户端版本不支持跳小程序时，将会跳转至url；

⑪ 处罚规则：

***违规的判定原则***

1.发模板的行为：
    
> ①模板消息不能主动下发给没有接受过服务的接收者（故障报警、灾害报警和不涉及营销推广的通知除外）
> 
> 例：某用户仅仅是关注公众号，没有和公众号及其所属主体有任何交互行为，却无故收到该公众号下发的模板消息，属于违规行为
> 
> ②模板消息的发送频率不能太高骚扰接收者
>
> 例：某用户点击公众号的自定义菜单一次或其它触发操作，连续收到3条或更多重复模板消息，属于违规行为

2.模板的内容：
    
> ①模板消息内容不能做营销、推广、诱导分享及诱导下载APP
> 
> 例：某用户购买某商品后，公众号下发模板推销其它商品，与用户此次接受的服务无关，属于违规
> 
> ②模板内容与模板标题或关键词无关联
> 
> 例：标题是刷卡成功通知，模板内容却是推销商品或活动通知，属于违规
> 
> ③模板内容是营销性质的群发活动公告通知
> 
> 例：标题小区物业通知，模板内容却是群发活动的营销信息

    综合上述两项原则后判断，主动下发、内容涉及恶意营销、频率过高恶意骚扰、以及模板参数内容乱填写将被封接口处罚。对于多次使用同一模板违规的，将回收
	违规模板，不允许再使用，违规处罚将通过微信公众平台站内信告知运营者。

### 5. 一次性订阅消息

① 其实是变种模板消息，需要用openId推送；

② 微信用户可以不需要关注公众号，1次1条；

③ 微信用户每授权一次，开发者可获得一次下发消息的权限。（注意：同一用户在同一scene场景值下的多次授权不累积下发权限，只能下发一条。若要订阅多条，需要不同scene场景值）

④ 消息下发位置说明：对于已关注公众号的，消息将下发到公众号会话里；未关注公众号的，将下发到服务通知；


## 二、小程序发消息能力

### 1. 模板消息

① 需要用openId推送；

② 需要有交互，获得交互结果prepay_id或formId，一个交互id只能7天内使用，prepary_id可以发3条，formId可以发1条，推送位置是服务通知；

③ 交互动作有（支付对应需要有prepay_id,提交表单对应需要有formId）：

1. 支付
> 当用户在小程序内完成过支付行为，可允许开发者向用户在7天内推送有限条数的模板消息（1次支付可下发3条，多次支付下发条数独立，互相不影响）
    
2. 提交表单
> 当用户在小程序内发生过提交表单行为且该表单声明为要发模板消息的，开发者需要向用户提供服务时，可允许开发者向用户在7天内推送有限条数的模板消息（1次提交表单可下发1条，多次提交下发条数独立，相互不影响）
    
④ 每个账号可以同时使用25个模板；

⑤ 目前默认每个帐号日调用限额为100万；

⑥ 模板消息支持跳转，仅限本小程序内的页面，支持带参数,（示例index?foo=bar），该字段不填则模板无跳转。

⑦ 支持放大某个关键词；

⑧ 处罚规则：

***违规说明***

除不能违反运营规范外，还不能违反以下规则，包括但不限于：
> 
> 不允许恶意诱导用户进行触发操作，以达到可向用户下发模板目的
> 不允许恶意骚扰，下发对用户造成骚扰的模板
> 不允许恶意营销，下发营销目的模板

⑨ 处罚说明
> 根据违规情况给予相应梯度的处罚，一般处罚规则如下：
> 
> 第一次违规，删除违规模板以示警告，
> 
> 第二次违规，封禁接口7天，
> 
> 第三次违规，封禁接口30天，
> 
> 第四次违规，永久封禁接口
> 
> 处罚结果及原因以站内信形式告知

### 2. 统一服务消息

① 推送小程序和服务号统一的模板消息，限制跟小程序和服务号的模板消息推送一样；

② 需要openId，可以是小程序的openId也可以是服务号openId；

③ 优先选择推送小程序模板消息，如无小程序模板消息配置才选择服务号模板通知；

### 3. 客服消息

① 需要用openId推送

② 需要跟用户有交互动作，并且在48小时内发送，只可发送5条；

③ 交互动作有：
> 1、用户发送消息

④ 支持发送文本，发送文本消息时，支持插入跳小程序的文字链

    <a href="http://www.qq.com" data-miniprogram-appid="appid" data-miniprogram-path="pages/index/index">点击跳小程序</a>

⑤ 支持发送图片，需要素材管理接口配合使用；

⑥ 支持发送图文消息，只可以用url方式，一次只能发送一个item；

⑦ 支持发送小程序卡片，可以跳转



## 三、微信服务号接收事件能力
### 1. 关注/取消关注事件

### 2. 扫描带参数二维码事件

### 3. 上报地理位置事件

### 4. 自定义菜单事件

### 5. 点击菜单拉取消息时的事件推送

### 6. 点击菜单跳转链接时的事件推送 

### 7. 群发消息任务结束时，会推送事件

### 8. 在模版消息发送任务完成后，会推送是否送达成功事件

### 9. 微信认证事件推送

### 10. 卡券事件推送

### 11. 用户在小程序“客服会话按钮”进入客服会话时将推送事件


## 一些特别的坑
### 在发红包接口那，String(32)的定义，意思是一个中文3个字符，一个数字1个字符，也就是10个中文2个数字。
